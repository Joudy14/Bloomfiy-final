@model List<Bloomfiy_final.Models.CartItem>
@{
    ViewBag.Title = "Shopping Cart";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.IncludeCartCss = true;
}

<section class="cart-page container">
    <h2>Shopping Cart</h2>

    @if (Model == null || !Model.Any())
    {
        <div class="cart-empty">
            Your cart is empty.
        </div>
    }
    else
    {
        <table class="cart-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Bouquet</th>
                    <th>Color</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                <tr>
                    <!-- PRODUCT -->
                    <td class="cart-product">
                        <img src="@item.ImageUrl" alt="@item.Name" class="cart-img" />
                        <div class="cart-product-info">
                            <strong>@item.Name</strong>
                        </div>
                    </td>

                    <td class=".cart-bouquet">
                        @item.HasBouquet
                    </td>
                    <!-- COLOR -->
                    <td class="cart-color">
                        @item.Color
                    </td>

                    <!-- PRICE (unit price) -->
                    <td class="cart-price">
                        $@item.Price
                    </td>

                    <!-- QUANTITY -->
                    <td class="cart-qty"
                        data-id="@item.ProductId"
                        data-color="@item.Color"
                        data-bouquet="@item.HasBouquet">
                        <button class="qty-btn minus">-</button>
                        <span class="qty-value">@item.Quantity</span>
                        <button class="qty-btn plus">+</button>
                    </td>

                    <!-- TOTAL -->
                    <td class="item-total">
                        $@item.TotalPrice
                    </td>

                    <!-- ACTION -->
                    <td>
                        <a href="@Url.Action(
                "Remove",
                "Cart",
                new { id = item.ProductId, color = item.Color, hasBouquet = item.HasBouquet }
            )" class="action-btn">
                            Remove
                        </a>
                    </td>
                </tr>
                }
            </tbody>

        </table>
        <div class="cart-summary">
            <h3>
                Total: <span id="cartTotalPrice">
                    $@Model.Sum(x => x.TotalPrice)
                </span>
            </h3>
        </div>

        <div class="cart-buttons">
            <a href="@Url.Action("Clear", "Cart")">Clear Cart</a>
            <a href="@Url.Action("Confirm", "Cart")">Checkout</a>
        </div>
    }
</section>
@section Scripts {
    <script>
$(document).on('click', '.qty-btn', function () {
    let $row = $(this).closest('.cart-qty');
    let id = $row.data('id');
    let color = $row.data('color');

    let $qty = $row.find('.qty-value');
    let current = parseInt($qty.text());

    if ($(this).hasClass('plus')) current++;
    if ($(this).hasClass('minus')) current--;

    if (current < 1) current = 0;

    $.post('/Cart/UpdateQuantity', {
        id: id,
        color: color,
        quantity: current
    }).done(function (res) {
        if (current === 0) {
            location.reload();
        } else {
            $qty.text(current);
            $row.closest('tr').find('.item-total').text('$' + res.itemTotal.toFixed(2));
            $('#cartTotalPrice').text('$' + res.cartTotal.toFixed(2));
        }
    });
});

        @if (ViewBag.RestoreCartFromLocalStorage == true)
            {
             <script>
        const savedCart = localStorage.getItem('bloomfiy_cart');
        if (savedCart) {
            $.ajax({
                url: '/Cart/RestoreFromLocalStorage',
                type: 'POST',
                contentType: 'application/json',
                data: savedCart,
                success: function () {
                    location.reload(); // Reload once cart restored
                }
            });
             </script>
            }
</script>
    }



